#!/bin/bash
set -eux -o pipefail

port=8554
netroot=192.168.101

function find_camera
{
  nmap -oG - -v -p "$port" "$netroot.0/24" \
    | grep "^Host: $netroot.[0-9]\+ ().*Ports: $port/" \
    | awk '{ print $2 }' \
    | sort -R \
    | head -1
}

cd /opt/cam_view

while sleep 1
do
  date
  ip=$(find_camera || continue)
  time ./receive "$ip"
done
